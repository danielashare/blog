<!doctype html>
<html lang="en" dir="ltr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="generator" content="Docusaurus v2.0.0-beta.4">
<link rel="alternate" type="application/rss+xml" href="/rss.xml" title="Daniel Share&#39;s Blog Blog RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/atom.xml" title="Daniel Share&#39;s Blog Blog Atom Feed"><title data-react-helmet="true">How to send multiple commands to and receive output from the same bash process | Daniel Share&#x27;s Blog</title><meta data-react-helmet="true" property="og:title" content="How to send multiple commands to and receive output from the same bash process | Daniel Share&#x27;s Blog"><meta data-react-helmet="true" property="og:url" content="https://danielshare.co.uk/how-to-send-multiple-commands-to-and-receive-output-from-the-same-bash-process"><meta data-react-helmet="true" name="docusaurus_locale" content="en"><meta data-react-helmet="true" name="docusaurus_tag" content="default"><meta data-react-helmet="true" name="twitter:card" content="summary_large_image"><meta data-react-helmet="true" name="twitter:site" content="@danielashare"><meta data-react-helmet="true" name="twitter:creator" content="@danielashare"><meta data-react-helmet="true" property="og:image" content="https://danielshare.co.uk/./img/hero/IPC.png"><meta data-react-helmet="true" name="twitter:image" content="https://danielshare.co.uk/./img/hero/IPC.png"><link data-react-helmet="true" rel="shortcut icon" href="/img/logo.png"><link data-react-helmet="true" rel="canonical" href="https://danielshare.co.uk/how-to-send-multiple-commands-to-and-receive-output-from-the-same-bash-process"><link data-react-helmet="true" rel="alternate" href="https://danielshare.co.uk/how-to-send-multiple-commands-to-and-receive-output-from-the-same-bash-process" hreflang="en"><link data-react-helmet="true" rel="alternate" href="https://danielshare.co.uk/how-to-send-multiple-commands-to-and-receive-output-from-the-same-bash-process" hreflang="x-default"><link rel="stylesheet" href="/assets/css/styles.8658c69f.css">
<link rel="preload" href="/assets/js/runtime~main.906caea9.js" as="script">
<link rel="preload" href="/assets/js/main.049f0b3d.js" as="script">
</head>
<body>
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}(),document.documentElement.setAttribute("data-announcement-bar-initially-dismissed",function(){try{return"true"===localStorage.getItem("docusaurus.announcement.dismiss")}catch(t){}return!1}())</script><div id="__docusaurus">
<div><a href="#" class="skipToContent_1oUP">Skip to main content</a></div><div class="announcementBar_3WsW" role="banner"><div class="announcementBarContent_3EUC announcementBarCloseable_3myR">Automatic database, file and server backups and management: <a target="_blank" rel="noopener" href="https://bakup.io">Bakup.io</a></div><button type="button" class="announcementBarClose_38nx clean-btn" aria-label="Close"><span aria-hidden="true">×</span></button></div><nav class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Navigation bar toggle" class="navbar__toggle clean-btn" type="button" tabindex="0"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><img src="/img/logo.png" alt="Blog Logo" class="themedImage_1VuW themedImage--light_3UqQ navbar__logo"><img src="/img/logo.png" alt="Blog Logo" class="themedImage_1VuW themedImage--dark_hz6m navbar__logo"><b class="navbar__title">Daniel Share&#x27;s Blog</b></a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/">Blog</a></div><div class="navbar__items navbar__items--right"><a href="https://bakup.io" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link"><span>Bakup.io<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_3J9K"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a><a href="https://twitter.com/danielashare" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link"><span>Twitter<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_3J9K"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a><a href="https://github.com/danielashare" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link"><span>GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_3J9K"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div class="main-wrapper blog-wrapper blog-post-page"><div class="container margin-vert--lg"><div class="row"><aside class="col col--3"><nav class="sidebar_2ahu thin-scrollbar" aria-label="Blog recent posts navigation"><div class="sidebarItemTitle_2hhb margin-bottom--md">Recent posts</div><ul class="sidebarItemList_2xAf"><li class="sidebarItem_2UVv"><a class="sidebarItemLink_1RT6" href="/different-types-of-data-loss-and-disasters-that-destroy-companies">Different types of data loss &amp; data disasters that destroy companies</a></li><li class="sidebarItem_2UVv"><a aria-current="page" class="sidebarItemLink_1RT6 sidebarItemLinkActive_12pM" href="/how-to-send-multiple-commands-to-and-receive-output-from-the-same-bash-process">How to send multiple commands to and receive output from the same bash process</a></li></ul></nav></aside><main class="col col--7"><article><header><h1 class="blogPostTitle_GeHD">How to send multiple commands to and receive output from the same bash process</h1><div class="blogPostData_291c margin-vert--md"><time datetime="2021-09-18T00:00:00.000Z">September 18, 2021</time> · 3 min read</div><div class="avatar margin-vert--md"><a href="https://twitter.com/danielashare" target="_blank" rel="noopener noreferrer" class="avatar__photo-link avatar__photo"><img src="./img/profile.jpeg" alt="Daniel Share"></a><div class="avatar__intro"><div class="avatar__name"><a href="https://twitter.com/danielashare" target="_blank" rel="noopener noreferrer">Daniel Share</a></div><small class="avatar__subtitle">CTO @ Superbition</small></div></div></header><div class="markdown"><p>Do you need two-way communication between a parent process and a persistent bash child process? I did when writing the
agent for <a href="https://bakup.io" target="_blank" rel="noopener noreferrer">Bakup.io</a> and there weren&#x27;t many resources out there which detailed a method of doing so.</p><div class="hr"><span></span><span></span><span></span></div><p>There are a list of requirements that I needed for the bash process:</p><ul><li>Send multiple commands and be able to read the output from a bash process</li><li>The bash process had to be persistent, not a new process for each command</li><li>Check the success/failure of each command</li></ul><p>These requirements pretty much rule out the use of <code>popen</code> and <code>system</code> as they will open a one-time write pipe to send your command, then they will read output off of the read pipe until the child exits.</p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="where-is-the-code"></a>Where is the code?<a class="hash-link" href="#where-is-the-code" title="Direct link to heading">#</a></h3><p>To find the code that I&#x27;ll be referring to, head over to the <a href="https://github.com/danielashare/two-way-bash-process-communication/blob/master/main.cpp" target="_blank" rel="noopener noreferrer">Github repo</a>.</p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="how-does-it-work"></a>How does it work?<a class="hash-link" href="#how-does-it-work" title="Direct link to heading">#</a></h2><p>In order to have two way communication with a shell, we must use the following:</p><ul><li><code>fork</code> To spawn a child process</li><li><code>execl</code> To start a shell on the child process</li><li><code>pipe</code> To connect to the read and write file descriptor of the child process</li></ul><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="starting-a-child"></a>Starting a child<a class="hash-link" href="#starting-a-child" title="Direct link to heading">#</a></h3><p>The <code>startChildShell</code> function takes in a reference to two ints which will be assigned values based on file descriptors it gets from creating pipes to the child process. Having these two file descriptors to write to and read from is what is lacking from the <code>popen</code> or <code>system</code> methods. It also takes a reference to a childPID, which will be populated with the newly created child&#x27;s Process ID. This is used to kill the process later.</p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="sending-commands-to-the-child"></a>Sending commands to the child<a class="hash-link" href="#sending-commands-to-the-child" title="Direct link to heading">#</a></h3><p>Once the child has been setup and we&#x27;ve extracted the file descriptors that allow us to write to and read from the child, we can start sending commands to it. When you send a command using the <code>runCommand</code> function, it will add two things to the end of the command:</p><ol><li>It will add <code>echo $?</code> which prints the exit code of the previous ran command</li><li>A randomly generated, long delimiter</li></ol><p>The delimiter is used to detect when the command has finshed excuting. We had a problem with the Agent and long running jobs, such as a <code>mysqldump</code>, which meant that we didn&#x27;t know when to stop reading the output of the child. The delimiter solves this problem by giving us a string to search for at the end of each line read from the buffer. When we see the delimiter, we know the command has finished (successfully or otherwise).</p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="how-do-i-compile-this-code"></a>How do I compile this code?<a class="hash-link" href="#how-do-i-compile-this-code" title="Direct link to heading">#</a></h3><p>You can build this code using the following command: <code>g++ -std=c++17 main.cpp -o main</code></p></div><footer class="row docusaurus-mt-lg blogPostDetailsFull_3kfx"><div class="col"><b>Tags:</b><a class="margin-horiz--sm" href="/tags/bash">bash</a><a class="margin-horiz--sm" href="/tags/shell">shell</a><a class="margin-horiz--sm" href="/tags/c">c++</a><a class="margin-horiz--sm" href="/tags/ipc">ipc</a></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Blog post page navigation"><div class="pagination-nav__item"><a class="pagination-nav__link" href="/different-types-of-data-loss-and-disasters-that-destroy-companies"><div class="pagination-nav__sublabel">Newer Post</div><div class="pagination-nav__label">« Different types of data loss &amp; data disasters that destroy companies</div></a></div><div class="pagination-nav__item pagination-nav__item--next"></div></nav></main><div class="col col--2"><div class="tableOfContents_35-E thin-scrollbar"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#where-is-the-code" class="table-of-contents__link">Where is the code?</a></li><li><a href="#how-does-it-work" class="table-of-contents__link">How does it work?</a><ul><li><a href="#starting-a-child" class="table-of-contents__link">Starting a child</a></li><li><a href="#sending-commands-to-the-child" class="table-of-contents__link">Sending commands to the child</a></li><li><a href="#how-do-i-compile-this-code" class="table-of-contents__link">How do I compile this code?</a></li></ul></li></ul></div></div></div></div></div></div>
<script src="/assets/js/runtime~main.906caea9.js"></script>
<script src="/assets/js/main.049f0b3d.js"></script>
</body>
</html>