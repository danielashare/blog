"use strict";(self.webpackChunkdanielshare_co_uk=self.webpackChunkdanielshare_co_uk||[]).push([[10],{3905:function(e,t,n){n.d(t,{Zo:function(){return d},kt:function(){return m}});var o=n(7294);function r(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function a(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(e);t&&(o=o.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,o)}return n}function i(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?a(Object(n),!0).forEach((function(t){r(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):a(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function l(e,t){if(null==e)return{};var n,o,r=function(e,t){if(null==e)return{};var n,o,r={},a=Object.keys(e);for(o=0;o<a.length;o++)n=a[o],t.indexOf(n)>=0||(r[n]=e[n]);return r}(e,t);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);for(o=0;o<a.length;o++)n=a[o],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(r[n]=e[n])}return r}var s=o.createContext({}),c=function(e){var t=o.useContext(s),n=t;return e&&(n="function"==typeof e?e(t):i(i({},t),e)),n},d=function(e){var t=c(e.components);return o.createElement(s.Provider,{value:t},e.children)},h={inlineCode:"code",wrapper:function(e){var t=e.children;return o.createElement(o.Fragment,{},t)}},p=o.forwardRef((function(e,t){var n=e.components,r=e.mdxType,a=e.originalType,s=e.parentName,d=l(e,["components","mdxType","originalType","parentName"]),p=c(n),m=r,u=p["".concat(s,".").concat(m)]||p[m]||h[m]||a;return n?o.createElement(u,i(i({ref:t},d),{},{components:n})):o.createElement(u,i({ref:t},d))}));function m(e,t){var n=arguments,r=t&&t.mdxType;if("string"==typeof e||r){var a=n.length,i=new Array(a);i[0]=p;var l={};for(var s in t)hasOwnProperty.call(t,s)&&(l[s]=t[s]);l.originalType=e,l.mdxType="string"==typeof e?e:r,i[1]=l;for(var c=2;c<a;c++)i[c]=n[c];return o.createElement.apply(null,i)}return o.createElement.apply(null,n)}p.displayName="MDXCreateElement"},8824:function(e,t,n){n.r(t),n.d(t,{frontMatter:function(){return l},contentTitle:function(){return s},metadata:function(){return c},toc:function(){return d},default:function(){return p}});var o=n(7462),r=n(3366),a=(n(7294),n(3905)),i=["components"],l={slug:"how-to-send-multiple-commands-to-and-receive-output-from-the-same-bash-process",title:"How to send multiple commands to and receive output from the same bash process",author:"Daniel Share",author_title:"CTO @ Superbition",author_url:"https://twitter.com/danielashare",author_image_url:"./img/profile.jpeg",tags:["bash","shell","c++","ipc"],image:"./img/hero/IPC.png",description:""},s=void 0,c={permalink:"/how-to-send-multiple-commands-to-and-receive-output-from-the-same-bash-process",source:"@site/blog/2021-09-18-How-to-send-commands-and-receive-output-from-the-same-bash-process.md",title:"How to send multiple commands to and receive output from the same bash process",description:"",date:"2021-09-18T00:00:00.000Z",formattedDate:"September 18, 2021",tags:[{label:"bash",permalink:"/tags/bash"},{label:"shell",permalink:"/tags/shell"},{label:"c++",permalink:"/tags/c"},{label:"ipc",permalink:"/tags/ipc"}],readingTime:2.3,truncated:!0,prevItem:{title:"Different types of data loss & data disasters that destroy companies",permalink:"/different-types-of-data-loss-and-disasters-that-destroy-companies"}},d=[{value:"Where is the code?",id:"where-is-the-code",children:[]},{value:"How does it work?",id:"how-does-it-work",children:[{value:"Starting a child",id:"starting-a-child",children:[]},{value:"Sending commands to the child",id:"sending-commands-to-the-child",children:[]},{value:"How do I compile this code?",id:"how-do-i-compile-this-code",children:[]}]}],h={toc:d};function p(e){var t=e.components,n=(0,r.Z)(e,i);return(0,a.kt)("wrapper",(0,o.Z)({},h,n,{components:t,mdxType:"MDXLayout"}),(0,a.kt)("p",null,"Do you need two-way communication between a parent process and a persistent bash child process? I did when writing the\nagent for ",(0,a.kt)("a",{parentName:"p",href:"https://bakup.io"},"Bakup.io")," and there weren't many resources out there which detailed a method of doing so."),(0,a.kt)("div",{className:"hr"},(0,a.kt)("span",null),(0,a.kt)("span",null),(0,a.kt)("span",null)),(0,a.kt)("p",null,"There are a list of requirements that I needed for the bash process:"),(0,a.kt)("ul",null,(0,a.kt)("li",{parentName:"ul"},"Send multiple commands and be able to read the output from a bash process"),(0,a.kt)("li",{parentName:"ul"},"The bash process had to be persistent, not a new process for each command"),(0,a.kt)("li",{parentName:"ul"},"Check the success/failure of each command")),(0,a.kt)("p",null,"These requirements pretty much rule out the use of ",(0,a.kt)("inlineCode",{parentName:"p"},"popen")," and ",(0,a.kt)("inlineCode",{parentName:"p"},"system")," as they will open a one-time write pipe to send your command, then they will read output off of the read pipe until the child exits."),(0,a.kt)("h3",{id:"where-is-the-code"},"Where is the code?"),(0,a.kt)("p",null,"To find the code that I'll be referring to, head over to the ",(0,a.kt)("a",{parentName:"p",href:"https://github.com/danielashare/two-way-bash-process-communication/blob/master/main.cpp"},"Github repo"),"."),(0,a.kt)("h2",{id:"how-does-it-work"},"How does it work?"),(0,a.kt)("p",null,"In order to have two way communication with a shell, we must use the following:"),(0,a.kt)("ul",null,(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("inlineCode",{parentName:"li"},"fork")," To spawn a child process"),(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("inlineCode",{parentName:"li"},"execl")," To start a shell on the child process"),(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("inlineCode",{parentName:"li"},"pipe")," To connect to the read and write file descriptor of the child process")),(0,a.kt)("h3",{id:"starting-a-child"},"Starting a child"),(0,a.kt)("p",null,"The ",(0,a.kt)("inlineCode",{parentName:"p"},"startChildShell")," function takes in a reference to two ints which will be assigned values based on file descriptors it gets from creating pipes to the child process. Having these two file descriptors to write to and read from is what is lacking from the ",(0,a.kt)("inlineCode",{parentName:"p"},"popen")," or ",(0,a.kt)("inlineCode",{parentName:"p"},"system")," methods. It also takes a reference to a childPID, which will be populated with the newly created child's Process ID. This is used to kill the process later."),(0,a.kt)("h3",{id:"sending-commands-to-the-child"},"Sending commands to the child"),(0,a.kt)("p",null,"Once the child has been setup and we've extracted the file descriptors that allow us to write to and read from the child, we can start sending commands to it. When you send a command using the ",(0,a.kt)("inlineCode",{parentName:"p"},"runCommand")," function, it will add two things to the end of the command:"),(0,a.kt)("ol",null,(0,a.kt)("li",{parentName:"ol"},"It will add ",(0,a.kt)("inlineCode",{parentName:"li"},"echo $?")," which prints the exit code of the previous ran command"),(0,a.kt)("li",{parentName:"ol"},"A randomly generated, long delimiter")),(0,a.kt)("p",null,"The delimiter is used to detect when the command has finshed excuting. We had a problem with the Agent and long running jobs, such as a ",(0,a.kt)("inlineCode",{parentName:"p"},"mysqldump"),", which meant that we didn't know when to stop reading the output of the child. The delimiter solves this problem by giving us a string to search for at the end of each line read from the buffer. When we see the delimiter, we know the command has finished (successfully or otherwise)."),(0,a.kt)("h3",{id:"how-do-i-compile-this-code"},"How do I compile this code?"),(0,a.kt)("p",null,"You can build this code using the following command: ",(0,a.kt)("inlineCode",{parentName:"p"},"g++ -std=c++17 main.cpp -o main")))}p.isMDXComponent=!0}}]);